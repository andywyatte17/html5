<!DOCTYPE html>
<html>

<head>
    <title>Darts Scoreboard</title>
    <script src="jquery-3.3.1.min.js"></script>
    <script src="processing-1.6.6.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/annyang/2.6.0/annyang.min.js"></script>
    <style>
        .scoreBtn button {
            min-width: 5em;
            height: 3em;
            margin: 0.2em;
        }
        
        .scoreBtnX button {
            min-width: 5em;
            height: 3em;
            margin: 0.2em;
            background: green;
            color: white;
        }
    </style>
</head>

<body>
    <!--  -->

    <h1>Darts Scoreboard</h1>

    <p>
        <label for="player1">Player 1:&nbsp;</label><input id="player1" type="text" name="player1" onblur="setPlayerNames()">
        <br>
        <label for="player2">Player 2:&nbsp;</label><input id="player2" type="text" name="player2" onblur="setPlayerNames()">
        <br>
        <button id="player1_clear">Clear Scores</button>
    </p>
    <div class="scoreBtn">
    </div>
    <div class="scoreBtnX">
        <button>1x</button>
        <button>2x</button>
        <button>3x</button> &nbsp;
        <button style="background: lightsalmon">No Score</button>
        <button style="background: lightsalmon">Bust</button>
    </div>

    <script type="application/javascript">
        var player1 = {
            startScore: 501,
            scores: [],
            name: ""
        };
        var player2 = {
            startScore: 501,
            scores: [],
            name: ""
        };

        function slice(arr, start, end) {
          var result = [];
          end = Math.min(end, arr.length);
          for(var i=start; i<end; i+=1)
            result.push(arr[i]);
          return result;
        }

        function player1Scores(n) { return slice(player1.scores, n*3, n*3+3).toString(); }

        function player2Scores(n) { return slice(player2.scores, n*3, n*3+3).toString(); }

        var undoStack = [];

        function addPreUndo() {
            undoStack.push({
                player1: JSON.stringify(player1),
                player2: JSON.stringify(player2)
            });
        }

        function undo() {
          try {
            var top = undoStack[undoStack.length-1];
            undoStack.pop();
            player1 = JSON.parse(top.player1);
            player2 = JSON.parse(top.player2);
          } finally {
          }
        }

        function setPlayerNames() {
            player1.name = document.getElementById('player1').value;
            player2.name = document.getElementById('player2').value;
        }

        function game(n) {
            addPreUndo();
            player1.startScore = n;
            player2.startScore = n;
        }

        function clearScores() {
          addPreUndo();
            player1.scores = [];
            player2.scores = [];
        }

        function score(n) {
          addPreUndo();
          var sum = player1.scores.length + player2.scores.length;
          if((sum%6)>=3)
            player2.scores.push(n);
          else
            player1.scores.push(n);
        }

        function initUi() {
            var numbers = $(".scoreBtn");
            for (var i = 1; i <= 20; i += 1) {
                var button = document.createElement("button");
                button.innerText = i.toString();
                button.onclick = function() {
                    score(n.toString());
                };
                numbers.append(button);
            }
        }

        $(document).ready(function() {
            initUi();
        });
    </script>

    <canvas id="pjs"> </canvas>

    <!-- -->

    <script type="application/processing" data-processing-target="pjs">
void setup() {
  size(600, 600);
  println('hello web!');
  background(200);
}

void draw() { 
  background(200); 
  fill(0, 0, 0); 
  textSize(20);
  for(int y=0; y<2+(player1.scores.length/3); y++)
  {
    int py = y * 30;
    if(y==0) {
      text(player1.name, 50, py);
    }
    else if(y==1) {
      text(player1.startScore, 50, py);
    }
    else {
      text(player1Scores(y-2), 50, py);
    }
  }
  for(int y=0; y<2+(player2.scores.length/3); y++)
  {
    int py = y * 30;
    if(y==0) {
      text(player2.name, 250, py);
    }
    else if(y==1) {
      text(player2.startScore, 250, py);
    }
    else {
      text(player2Scores(y-2), 250, py);
    }
  }
}
    </script>

    <!-- -->
    <script>
        if (annyang) {
            var MakeGameFunction = function(n) {
                return function() {
                    game(n);
                };
            };

            var MakeScoreFunction = function(s) {
                return function() {
                    score(s);
                };
            };
            var commands = {};

            var games = [
                ["game 5 oh 1", 501],
                ["game 3 oh 1", 301],
                ["game 2 oh 1", 201]
            ];
            for (var x = 0; x < games.length; x += 1) {
                var game = games[x];
                commands[game[0]] = MakeGameFunction(game[1]);
            }

            var amounts = ["", "single ", "double ", "treble "];

            for (var x = 0; x < amounts.length; x += 1) {
                let amount = amounts[x];
                for (var y = 1; y <= 25; y += 1) {
                    if (21 <= y && y <= 24)
                        continue;
                    var s = amount + y.toString();
                    var alternatives = [];
                    alternatives.push(s);
                    if (s === "single 25")
                        alternatives = ["25", "outer bull"];
                    if (s === "double 25")
                        alternatives = ["bull", "bulls-eye"];
                    if (s === "triple 25")
                        alternatives = [];
                    for (let z = 0; z < alternatives.length; z += 1) {
                        var s2 = y.toString();
                        if (x === 2) s2 += "\u00b2";
                        if (x === 3) s2 += "\u00b3";
                        commands[alternatives[z]] = MakeScoreFunction(s2);
                    }
                }
            }
            commands["no score"] = MakeScoreFunction("no score");
            commands["bust"] = MakeScoreFunction("bust");
            commands["clear scores"] = MakeScoreFunction();
            commands["undo"] = function() {
                undo();
            };

            console.log(commands);
            annyang.addCommands(commands);

            // Start listening. You can call this here, or attach this call to an event, button, etc.
            annyang.start();
        }
    </script>
</body>

</html>