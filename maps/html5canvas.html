<!DOCTYPE HTML>
<html>
  <head>
    <style>
      body {
        margin: 5px;
        padding: 5px;
      }
    </style>
    <script src="js/jquery-2.0.0b2.js"></script>
    <script src="js/detectMoveOrDrag.js"></script>    
    <script src="js/mapConfig.js"></script>
  </head>
  <body>
    <h2 class="map_title">_map_title_</h2>
    <canvas id="myCanvas" width="800" height="500"></canvas>
    <p class="mouseEvents"></p>
    <p class="mouseOrNot">No Mouse.</p>
    <script>
      var ox = 0, oy = 0
      var mouseX = -5000, mouseY = -5000, inMouse = false
      var canvas = document.getElementById('myCanvas');
      
      //$('#myCanvas').width( canvas_width )
      //$('#myCanvas').height( canvas_height )
      
      $('h2.map_title').text(map_title);
      if( !debug_mouse ) {
        $('p.mouseEvents').hide();
        $('p.mouseOrNot').hide();
      }

      function writeMessage(message) {
        if(debug_mouse)
          $('p.mouseEvents').text(message)
      }

      function drawCanvas() {
        var context = canvas.getContext('2d');
        context.clearRect(0, 0, canvas.width, canvas.height)
        // context.drawImage(imageObj, ox, oy);
        for(var w = tileW_lo; w<=tileW_hi; w++)
          for(var h = tileH_lo; h<=tileH_hi; h++)
            context.drawImage( imageMap[w][h], ox + (w-tileW_lo)*256, oy + (h-tileH_lo)*256 );
      }

      function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
        };
      }

      function getTouchPos(evt) {
        return {
          x: evt.touches.item(0).screenX,
          y: evt.touches.item(0).screenY
        };
      }
      
      if( !isMouseMoveNotDrag )
      {
        canvas.addEventListener('mousedown', function(evt) {
          var mousePos = getMousePos(canvas, evt);
          mouseX = mousePos.x
          mouseY = mousePos.y
          inMouse = true

          var message = 'mousedown ' + mousePos.x + ',' + mousePos.y;
          writeMessage(message)

        }, false);

        canvas.addEventListener('mousemove', function(evt) {
          if (inMouse) {
            var mousePos = getMousePos(canvas, evt);
            ox += mousePos.x - mouseX
            oy += mousePos.y - mouseY
            drawCanvas()
            mouseX = mousePos.x
            mouseY = mousePos.y
            var message = 'mousemove ' + mousePos.x + ',' + mousePos.y;
            writeMessage(message)
          }
        }, false);
                
        canvas.addEventListener('mouseup', function(evt) { inMouse = false }, false );
      }
      else
      {
        canvas.addEventListener('touchstart', function(evt) {
          var mousePos = getTouchPos(evt);
          mouseX = mousePos.x
          mouseY = mousePos.y
          var message = 'touchstart ' + mousePos.x + ',' + mousePos.y;
          writeMessage(canvas1, message)
        }, false);

        canvas.addEventListener('touchmove', function(evt) {
            var mousePos = getTouchPos(evt);
            ox += mousePos.x - mouseX
            oy += mousePos.y - mouseY
            drawCanvas()
            mouseX = mousePos.x
            mouseY = mousePos.y
            var message = 'touchmove ' + mousePos.x + ',' + mousePos.y;
            writeMessage(canvas1, message)
        }, false);
      }

      /*
      var imageObj = new Image();
      imageObj.onload = function() {
        drawCanvas()
      };
      imageObj.src = 'http://www.html5canvastutorials.com/demos/assets/darth-vader.jpg';
       */
      
      var imageMap = {};
      for(var w=tileW_lo; w<=tileW_hi; w++)
      {
        imageMap[w] = {};
        for(var h=tileH_lo; h<=tileH_hi; h++)
        {
          var io = new Image();
          io.onload = function() {
            drawCanvas()
          };
          io.src = 'tiles/' + tile_zoom + '/' + w + '/' + h + '.png';
          imageMap[w][h] = io;
        }
      }
      
    </script>
  </body>
</html>