<!DOCTYPE HTML>
<html>
  <head>
    <style>
      body {
        margin: 5px;
        padding: 5px;
      }
      </style>
    <script src="js/jquery-2.0.0b2.js"></script>
    <script src="js/detectMoveOrDrag.js"></script>    
    <script src="js/mapConfig.js"></script>
  </head>
  <body>
    <h3 id="map_title">_map_title_</h3>
    <canvas id="myCanvas" width="950" height="400"></canvas>
    <p>
      <div id="mouseStuffTable">
          <div id="mouseOrNot" style="width:50%;float:left;display:inline-block;">&nbsp;</div>
          <div id="mouseEvents">&nbsp;</div>
      </div>
    </p>
    <script>
      var ox = 0, oy = 0
      var mouseX = -5000, mouseY = -5000, inMouse = false
      var canvas = document.getElementById('myCanvas');
      
      $('#map_title').text(map_title);
      if( !debug_mouse )
        $('#mouseStuffTable').hide();
      
      function writeMessage(message) {
        if(debug_mouse)
          $('#mouseEvents').text(message)
      }
      
      function ValidateOxOy() {
        var left = -(tileW_hi-tileW_lo+1)*256 + canvas.width;
        var top = -(tileH_hi-tileH_lo+1)*256 + canvas.height;
        if(ox>0) ox = 0;
        if(ox<left) ox = left;
        if(oy>0) oy = 0;
        if(oy<top) oy = top;
      }
      
      function drawCanvas() {
        var context = canvas.getContext('2d');
        context.clearRect(0, 0, canvas.width, canvas.height)
        for(var w = tileW_lo; w<=tileW_hi; w++)
          for(var h = tileH_lo; h<=tileH_hi; h++)
          {
            var px = ox + (w-tileW_lo)*256;
            var py = oy + (h-tileH_lo)*256;
            if( (px+255)<0 ) continue;
            if( (py+255)<0 ) continue;
            if( (px-255)>canvas.width ) continue;
            if( (py-255)>canvas.height ) continue;

            if( !imageMap[w][h].src || imageMap[w][h].src=='' ) {
              imageMap[w][h].src = imageStr[w][h];
              imageTryLoading[w][h] = true;
            }
            else
              context.drawImage( imageMap[w][h], px, py );
          }
      }
      
      function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
        };
      }
      
      function getTouchPos(evt) {
        return {
          x: evt.touches.item(0).screenX,
          y: evt.touches.item(0).screenY
        };
      }
      
      var mouseDownFn = function(evt) {
        var mousePos = getMousePos(canvas, evt);
        mouseX = mousePos.x
        mouseY = mousePos.y
        inMouse = true        
        var message = 'mousedown ' + mousePos.x + ',' + mousePos.y;
        writeMessage(message)
      };
      
      var mouseMoveFn = function(evt) {
        if (!evt.buttons )
          inMouse = false
        if (inMouse) {
          var mousePos = getMousePos(canvas, evt);
          ox += mousePos.x - mouseX
          oy += mousePos.y - mouseY
          ValidateOxOy()
          drawCanvas()
          mouseX = mousePos.x
          mouseY = mousePos.y
          var message = 'mousemove ' + mousePos.x + ',' + mousePos.y + '{' + ox + ',' + oy + '}';
          writeMessage(message)
        }
      };

      var mouseUpFn = function(evt) {
        if (inMouse) {
          inMouse = false
          var mousePos = getMousePos(canvas, evt);
          var message = 'mouseup ' + mousePos.x + ',' + mousePos.y + '{' + ox + ',' + oy + '}';
          writeMessage(message)
        }
      };
      
      var touchStartFn = function(evt) {
        evt.preventDefault();  // Important! touchMove won't work well without this
        var mousePos = getTouchPos(evt);
        mouseX = mousePos.x
        mouseY = mousePos.y
        var message = 'touchstart ' + mousePos.x + ',' + mousePos.y;
        writeMessage(message)
      };
      
      var touchMoveFn = function(evt) {
        var mousePos = getTouchPos(evt);
        ox += mousePos.x - mouseX
        oy += mousePos.y - mouseY
        ValidateOxOy()
        drawCanvas()
        mouseX = mousePos.x
        mouseY = mousePos.y
        var message = 'touchmove ' + mousePos.x + ',' + mousePos.y;
        writeMessage(message)
      };
      
      var touchEndFn = function(evt) {
        var mousePos = getTouchPos(evt);
        var message = 'touchend ' + mousePos.x + ',' + mousePos.y;
        writeMessage(message)
      };
      
      // Setup event listeners
      canvas.addEventListener('mousedown', mouseDownFn, false);
      canvas.addEventListener('mousemove', mouseMoveFn, false);
      canvas.addEventListener('mouseup', mouseUpFn, false);
      canvas.addEventListener('touchstart', touchStartFn, false);
      canvas.addEventListener('touchmove', touchMoveFn, false);
      canvas.addEventListener('touchend', touchEndFn, false);
      
      var imageMap = {}, imageStr = {};
      for(var w=tileW_lo; w<=tileW_hi; w++)
      {
        imageMap[w] = {};
        imageStr[w] = {};
        for(var h=tileH_lo; h<=tileH_hi; h++)
        {
          var io = new Image();
          io.onload = function() { drawCanvas(); };
          imageStr[w][h] = 'tiles/' + tile_zoom + '/' + w + '/' + h + '.png';
          imageMap[w][h] = io;
          // imageMap[w][h].src = imageStr[w][h];
        }
      }
      drawCanvas();
      
      </script>
  </body>
</html>